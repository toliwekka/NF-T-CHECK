<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>NFT Consult Report | Mental Well-being Dashboard</title>
        <link rel="icon" type="image/png" href="logo.jpeg" />

        <!-- External Libraries -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

        <!-- Fix: Correct way to include Font Awesome (use link instead of script) -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

        <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

        <!-- Firebase SDKs - Corrected order and script tags for Firebase -->
        <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>

        <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

        <!-- Styles -->
        <style>
            :root {
                --primary: #4b9a71;
                --secondary: #d35400;
                --bg: #f1f9f4;
                --card-bg: #ffffff;
                --text-color: #444;
                --accent: #8e44ad;
                --border-color: #dfe6e9;
            }
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                font-family: "Segoe UI", sans-serif;
                background-color: var(--bg);
                color: var(--text-color);
            }
            header,
            .footer {
                background: var(--primary);
                color: #fff;
                text-align: center;
                padding: 1.5rem 2rem;
                font-size: 2rem;
                font-weight: 600;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            }
            .container {
                padding: 2rem;
            }
            .map-card,
            .stat-card,
            .card {
                background: var(--card-bg);
                border-radius: 12px;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
                margin-bottom: 2rem;
            }
            .map-card {
                width: 48%;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .map-card:hover {
                transform: scale(1.05);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            }
            .map-header {
                background: var(--primary);
                color: #fff;
                padding: 1rem;
                text-align: center;
                font-size: 1.2rem;
                font-weight: 600;
            }
            .map-container {
                width: 100%;
                height: 400px;
            }
            .stats-bar {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
            }
            .stat-card {
                flex: 1;
                min-width: 220px;
                padding: 1.5rem;
            }
            .stat-card h4 {
                color: #666;
                font-size: 1.1rem;
            }
            .stat-card .value {
                font-size: 2rem;
                font-weight: bold;
                color: var(--primary);
            }
            .dashboard {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 2rem;
            }
            .card {
                padding: 1rem;
            }
            .card h3 {
                margin-bottom: 1rem;
                color: var(--primary);
            }
            .pill {
                padding: 0.2rem 0.6rem;
                border-radius: 999px;
                font-size: 0.8rem;
                display: inline-block;
                color: #fff;
            }
            .pill.red {
                background: #e74c3c;
            }
            .pill.orange {
                background: #e67e22;
            }
            .pill.yellow {
                background: #f1c40f;
                color: #000;
            }
            .pill.green {
                background: var(--secondary);
            }
            .leaflet-control-attribution {
                display: none !important;
            }
        </style>

        <style>
            body {
                font-family: "Poppins", sans-serif;
                margin: 0;
                background: #f4fdf9;
            }
            header {
                background: #2a7a4e;
                color: white;
                padding: 1rem;
                text-align: center;
                font-size: 1.5rem;
                font-weight: bold;
            }
            #calendarContainer {
                padding: 2rem;
                max-width: 1100px;
                margin: auto;
            }
            .fc-daygrid-event {
                background: #065f46;
                color: #fff;
                font-weight: 600;
                padding: 6px 10px;
                border-radius: 10px;
                font-size: 0.85rem;
                text-align: center;
            }
            #modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                justify-content: center;
                align-items: center;
                z-index: 9999;
            }
            #modalContent {
                background: white;
                padding: 2rem;
                border-radius: 16px;
                max-width: 700px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
                position: relative;
            }
            .close-btn {
                position: absolute;
                right: 1rem;
                top: 1rem;
                cursor: pointer;
                font-size: 1.5rem;
            }
            .assessment-entry {
                background: #f0fdfa;
                padding: 1rem;
                margin-bottom: 1rem;
                border-left: 6px solid #2a7a4e;
                border-radius: 12px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            }
            .score {
                font-weight: bold;
                margin-left: 5px;
                padding: 2px 6px;
                border-radius: 6px;
            }
            .low {
                background: #facc15;
                color: #000;
            }
            .medium {
                background: #34d399;
                color: white;
            }
            .high {
                background: #ef4444;
                color: white;
            }
            button {
                background: #2a7a4e;
                color: white;
                padding: 0.5rem 1rem;
                margin-top: 1rem;
                margin-right: 0.5rem;
                border: none;
                border-radius: 8px;
                cursor: pointer;
            }
            canvas {
                max-width: 100%;
                margin-top: 1rem;
            }
        </style>

        <style>
            .accordion-toggle {
                background-color: #2a7a4e;
                color: #fff;
                padding: 10px;
                width: 100%;
                text-align: left;
                border: none;
                cursor: pointer;
                font-weight: bold;
                margin-top: 8px;
                border-radius: 6px;
            }

            .accordion-content {
                display: none;
                padding: 10px;
                border: 1px solid #ccc;
                margin-bottom: 10px;
                background: #f9f9f9;
                border-radius: 6px;
            }

            .accordion-content table {
                width: 100%;
                border-collapse: collapse;
            }

            .accordion-content th,
            .accordion-content td {
                padding: 8px;
                border: 1px solid #ddd;
            }

            .accordion-content th {
                background-color: #e6e6e6;
            }
        </style>

        <script>
            function toggleAccordion(id) {
                const content = document.getElementById(id);
                content.style.display = content.style.display === "block" ? "none" : "block";
            }
        </script>

        <!-- Add Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

        <!-- Custom Styling Enhancements -->
        <style>
            body {
                font-family: "Poppins", sans-serif;
                background: linear-gradient(to bottom, #f4fdf9, #e6f5ed);
                color: #444;
                padding-top: 4rem;
            }

            .glass-card {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.75);
                border-radius: 16px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                padding: 1.5rem;
                margin-bottom: 2rem;
                transition: all 0.3s ease;
            }

            .glass-card:hover {
                transform: scale(1.02);
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            }

            header {
                background: linear-gradient(135deg, #2a7a4e, #44b78b);
                color: white;
                padding: 1.5rem;
                text-align: center;
                font-size: 2rem;
                font-weight: bold;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            }

            .btn-primary {
                background-color: #2a7a4e;
                border: none;
            }
        </style>

        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />

        <style>
            body {
                font-family: "Poppins", sans-serif;
                background: linear-gradient(to bottom, #f4fdf9, #e6f5ed);
                color: #444;
                padding-top: 4rem;
            }

            header {
                background: linear-gradient(135deg, #2a7a4e, #44b78b);
                color: white;
                padding: 2rem;
                text-align: center;
                font-size: 2.5rem;
                font-weight: bold;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            }

            .glass-card {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.75);
                border-radius: 16px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                padding: 1.5rem;
                margin-bottom: 2rem;
                transition: all 0.3s ease;
            }

            .glass-card:hover {
                transform: scale(1.02);
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            }

            .map-container {
                height: 400px;
                width: 100%;
                border-radius: 12px;
                overflow: hidden;
            }

            .btn-primary {
                background-color: #2a7a4e;
                border: none;
            }
        </style>

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <style>
            body {
                font-family: "Poppins", sans-serif;
                background: linear-gradient(to bottom, #f4fdf9, #e6f5ed);
                color: #333;
                padding-top: 4rem;
            }

            header {
                background: linear-gradient(135deg, #2a7a4e, #44b78b);
                color: white;
                padding: 1.5rem;
                text-align: center;
                font-size: 2rem;
                font-weight: bold;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            }

            .glass-card {
                backdrop-filter: blur(10px);
                background: rgba(255, 255, 255, 0.8);
                border-radius: 16px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
                padding: 1.5rem;
                transition: all 0.3s ease;
            }

            .glass-card:hover {
                transform: scale(1.02);
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            }

            .map-container {
                height: 400px;
                background-color: #dff0e4;
                border-radius: 12px;
            }

            .btn-primary {
                background-color: #2a7a4e;
                border: none;
            }

            .btn-primary:hover {
                background-color: #226b44;
            }
        </style>

        <!-- Bootstrap & Fonts -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet" />

        <style>
            :root {
                --primary-mint: #aaf0d1;
                --mint-dark: #2a7a4e;
                --mint-soft: #d0f5e0;
                --bg: #f0fff9;
                --card-bg: #ffffff;
                --footer-bg: #930d0e;
                --accent: #16a085;
                --text-color: #222;
                --glass: rgba(255, 255, 255, 0.65);
            }

            body {
                font-family: "Poppins", sans-serif;
                background-color: var(--bg);
                color: var(--text-color);
                overflow-x: hidden;
            }

            header {
                background: linear-gradient(to right, var(--primary-mint), var(--mint-dark));
                color: white;
                padding: 2rem 1rem;
                text-align: center;
                font-size: 2rem;
                font-weight: 800;
                letter-spacing: 1px;
            }

            .glass-card {
                background: var(--glass);
                backdrop-filter: blur(8px);
                border-radius: 1.5rem;
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
                padding: 1.5rem;
                margin-bottom: 2rem;
            }

            .section-title {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--mint-dark);
                margin-bottom: 1rem;
            }

            .stat-box {
                background: var(--mint-soft);
                border-left: 6px solid var(--mint-dark);
                padding: 1.25rem;
                border-radius: 1rem;
                font-size: 1.1rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                transition: transform 0.2s ease;
            }

            .stat-box:hover {
                transform: scale(1.02);
            }

            .dashboard-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 2rem;
            }

            .footer {
                background: var(--footer-bg);
                color: white;
                text-align: center;
                padding: 1.5rem 1rem;
                margin-top: 4rem;
                font-size: 1rem;
            }

            .gamify-badge {
                background: #fff;
                color: var(--mint-dark);
                padding: 0.5rem 1rem;
                border-radius: 999px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                display: inline-block;
            }

            .map-container,
            .chart-container,
            .calendar-container {
                height: 400px;
                border-radius: 1rem;
                overflow: hidden;
                margin-bottom: 2rem;
                background-color: #fff;
            }

            .modal-content {
                border-radius: 1rem;
            }
        </style>
        <style>
            body {
                padding-left: 240px; /* pushes content right to leave room for sidebar */
            }

            @media (max-width: 768px) {
                #sidebar {
                    display: none;
                }

                body {
                    padding-left: 0;
                }
            }
        </style>
    </head>
    <body>
        <header>
            NFT Consult Mental Well-Being Dashboard
        </header>

        <div id="sidebar" class="position-fixed top-0 start-0 h-100 bg-white shadow-lg p-3 d-flex flex-column" style="width: 220px; z-index: 1040;">
            <h5 class="text-success fw-bold mb-4">NFT Admin</h5>
            <a href="#mapPartA" class="mb-2 text-decoration-none text-dark">üåç Affective Map</a>
            <a href="#mapPartB" class="mb-2 text-decoration-none text-dark">üß† Functional Map</a>
            <a href="#countryResponseChart" class="mb-2 text-decoration-none text-dark">üìä Country Chart</a>
            <a href="#calendar" class="mb-2 text-decoration-none text-dark">üìÖ Calendar</a>
            <a href="#userListSection" class="mb-2 text-decoration-none text-dark">üë§ Users</a>
            <a href="#institutionLeaderboard" class="mb-2 text-decoration-none text-dark">üèÜ Institutions</a>
            <a href="#downloadCenter" class="mb-2 text-decoration-none text-dark">‚¨áÔ∏è Downloads</a>
            <a href="#" class="mt-auto btn btn-outline-danger" onclick="logoutAdmin()">Logout</a>
        </div>

        <main class="container py-4">
            <div class="dashboard-grid">
                <div class="glass-card">
                    <div class="section-title">Map: Affective Well-being Scale Pulse A</div>
                    <div id="mapPartA" class="map-container"></div>
                </div>
            </div>
            <div class="dashboard-grid">
                <div class="glass-card">
                    <div class="section-title">Map: Functional Well-being Scale Pulse B</div>
                    <div id="mapPartB" class="map-container"></div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-box text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <div><strong>Total Responses</strong></div>
                    <div id="totalResponses" class="display-6">0</div>
                </div>
            </div>

            <div class="glass-card">
                <div class="section-title">Response Chart by Country</div>
                <div id="countryResponseChart" class="chart-container"></div>
            </div>

            <div class="glass-card">
                <div class="section-title">Color Breakdown by Country</div>
                <div id="colorBreakdownChart" style="width: 100%; height: 500px;"></div>
            </div>

            <div class="glass-card">
                <div class="section-title">Calendar of Activities</div>
                <div id="calendar" class="calendar-container"></div>
                <div id="modal">
                    <div id="modalContent">
                        <span class="close-btn" onclick="document.getElementById('modal').style.display='none'">&times;</span>
                        <h3>Daily Assessments</h3>
                        <div id="modalBody"></div>
                        <div id="partAChart" style="width: 100%; height: 400px;"></div>
                        <div id="partBChart" style="width: 100%; height: 400px;"></div>
                        <button onclick="downloadPDF()">Download PDF</button>
                        <button onclick="sendEmail()">Email Report</button>
                    </div>
                </div>
            </div>

            <!-- NEW: User List Table -->
            <div class="glass-card" id="userListSection">
                <div class="section-title">üë§ User Responses</div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="userTable">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Country</th>
                                <th>Employment Status</th>
                                <th>Institution</th>
                                <th>Score A</th>
                                <th>Score B</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button class="btn btn-success mt-2" onclick="exportUsersCSV()">Export CSV</button>
            </div>

            <!-- NEW: Top Institutions Leaderboard -->
            <div class="glass-card" id="institutionLeaderboard">
                <div class="section-title">üèÜ Top Institutions</div>
                <ul id="institutionList" class="list-group"></ul>
            </div>

            <!-- NEW: Download Center -->
            <div class="glass-card" id="downloadCenter">
                <div class="section-title">‚¨áÔ∏è Download Center</div>
                <button class="btn btn-outline-primary" onclick="downloadPDF()">Download PDF</button>
                <button class="btn btn-outline-secondary" onclick="exportUsersCSV()">Export Full CSV</button>
            </div>
        </main>

        <footer class="footer">
            &copy; 2025 NFT Consult | Powered by Toli Wekka
        </footer>

        <!-- Bootstrap & Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

        <div class="container">
            <div class="dashboard" style="display: none;" ;>
                <div class="card" style="display: none;" ;>
                    <h3>Average Score by Country: Part A</h3>
                    <div id="countryPartAChart"></div>
                </div>
                <div class="card">
                    <h3>Average Score by Country: Part B</h3>
                    <div id="countryPartBChart"></div>
                </div>
            </div>

            <div class="dashboard" style="display: none;" ;>
                <div class="card">
                    <h3>Distribution: Part A</h3>
                    <div id="partAChart"></div>
                </div>
                <div class="card">
                    <h3>Distribution: Part B</h3>
                    <div id="partBChart"></div>
                </div>
            </div>
        </div>

        <script>
            const firebaseConfig = {
                apiKey: "AIzaSyDeDsOiA6QP4qbedd_JmQ9na1hM3sf4y3Q",
                authDomain: "mentalhealthtracker-15563.firebaseapp.com",
                projectId: "mentalhealthtracker-15563",
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            const mapPartA = L.map("mapPartA").setView([0, 0], 2);
            const mapPartB = L.map("mapPartB").setView([0, 0], 2);
            L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png").addTo(mapPartA);
            L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png").addTo(mapPartB);

            const COLOR_RANGES = {
                partA: [
                    { max: 57, color: "#FF0000" },
                    { max: 63, color: "#FF8C00" },
                    { max: 86, color: "#FFFC00" },
                    { max: Infinity, color: "#00FF00" },
                ],
                partB: [
                    { max: 29, color: "#FF0000" },
                    { max: 54, color: "#FF8C00" },
                    { max: 79, color: "#FFFC00" },
                    { max: Infinity, color: "#00FF00" },
                ],
            };

            const COLOR_RANGESXX = {
                partA: [
                    { min: 0, max: 57, color: "red" },
                    { min: 58, max: 63, color: "orange" },
                    { min: 64, max: 86, color: "yellow" },
                    { min: 87, max: 100, color: "green" },
                ],
                partB: [
                    { min: 0, max: 29, color: "red" },
                    { min: 30, max: 54, color: "orange" },
                    { min: 55, max: 79, color: "yellow" },
                    { min: 80, max: 100, color: "green" },
                ],
            };

            const COLORS = {
                red: "#ff4d4d",
                orange: "#ffa500",
                yellow: "#ffff66",
                green: "#66cc66",
            };

            const getColor = (score, type) => COLOR_RANGES[type].find((r) => score <= r.max).color;
            const getColorX = (score, part) => COLOR_RANGESXX[part].find((r) => score >= r.min && score <= r.max)?.color || "unknown";

            const geocodeAddress = async (address, country) => {
                if (!address || !country) return null;
                try {
                    const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(address + ", " + country)}&limit=1`;
                    const res = await fetch(url);
                    const json = await res.json();
                    const coords = json?.features?.[0]?.geometry?.coordinates;
                    return coords ? { lat: coords[1], lon: coords[0] } : null;
                } catch {
                    console.warn("Geocoding failed:", address, country);
                    return null;
                }
            };

            const renderMarker = (map, { lat, lon, color, name, address, label }) => {
                L.circleMarker([lat, lon], {
                    color,
                    fillColor: color,
                    fillOpacity: 0.7,
                    radius: 10,
                })
                    .addTo(map)
                    .bindPopup(`<b>${name}</b><br>${address}<br><span class="pill" style="background-color:${color}">${label}</span>`);
            };

            const processData = async () => {
                const snapshot = await db.collection("nftclientResponses").get();
                const docs = snapshot.docs.map((doc) => ({ id: doc.id, ref: doc.ref, ...doc.data() }));

                const partA = [],
                    partB = [],
                    markers = [];
                let count = 0;
                const countryScoresA = {},
                    countryScoresB = {},
                    countryCounts = {};

                const uniqueMap = new Map();

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const key = [data.form_005_first_name?.trim().toLowerCase(), data.form_006_last_name?.trim().toLowerCase(), data.form_008_phone?.trim()].join("||");

                    if (!uniqueMap.has(key)) {
                        uniqueMap.set(key, { id: doc.id, ...data });

                        const country = data.form_003_evaluation_country?.trim().toLowerCase() || "unknown";

                        if (!countryCounts[country]) {
                            countryCounts[country] = 1;
                        } else {
                            countryCounts[country]++;
                        }
                    }
                });

                count = uniqueMap.size;
                console.log("Unique Responses:", count);
                console.log("Breakdown by Country:", countryCounts);

                await Promise.all(
                    docs.map(async (d) => {
                        const { form_016_employment: institution, form_002_evaluation_address: address, form_003_evaluation_country: country } = d;
                        const name = d["form_005_first-name"] || "Anonymous";

                        const scoreA = Number(d.form_042_PartA_Score) || 0;
                        const scoreB = Number(d.form_044_PartB_Score) || 0;
                        const percA = +((scoreA / 70) * 100).toFixed(2);
                        const percB = +((scoreB / 240) * 100).toFixed(2);

                        partA.push(percA);
                        partB.push(percB);

                        if (!address || !country) return;

                        let { geolocation_lat: lat, geolocation_lon: lon } = d;
                        let coords = lat && lon ? { lat, lon } : await geocodeAddress(address, country);

                        if (!coords) return;
                        if (!lat || !lon) {
                            await d.ref.update({
                                geolocation_lat: coords.lat,
                                geolocation_lon: coords.lon,
                            });
                        }

                        // include both raw scores
                        markers.push({ name, address, scoreA, scoreB, percA, percB, ...coords });
                    })
                );

                // now destructuring includes scoreA and scoreB:
                markers.forEach(({ lat, lon, name, address, scoreA, scoreB, percA, percB }) => {
                    renderMarker(mapPartA, {
                        lat,
                        lon,
                        name,
                        address,
                        color: getColor(percA, "partA"),
                        // show both raw and percent
                        label: `Part A: ${scoreA} (${percA}%)`,
                    });
                    renderMarker(mapPartB, {
                        lat,
                        lon,
                        name,
                        address,
                        color: getColor(percB, "partB"),
                        label: `Part B: ${scoreB} (${percB}%)`,
                    });
                });

                document.getElementById("totalResponses").innerText = count;
                renderCountryResponseChart(countryCounts);
                renderColorSummaryChart("partAChart", partA, "Part A %");
                renderColorSummaryChart("partBChart", partB, "Part B %");
                renderCountryAvgChart("countryPartAChart", countryScoresA, "Average Part A % by Country");
                renderCountryAvgChart("countryPartBChart", countryScoresB, "Average Part B % by Country");

                const resultsByCountry = buildCountryResults(docs);
                console.log("Breakdown by Country:", resultsByCountry);

                renderCountryBreakdown(resultsByCountry);
                plotCountryBreakdown(resultsByCountry);
                fetchUserResponses();
            };

            const renderColorSummaryChart = (id, data, title) => {
                const ranges = COLOR_RANGES[title.includes("Part A") ? "partA" : "partB"];
                const labels = title.includes("Part A") ? ["0-57", "58-63", "64-86", "87-100"] : ["0-29", "30-54", "55-79", "80-100"];
                const counts = Array(ranges.length).fill(0);

                data.forEach((score) => {
                    if (!isNaN(score)) {
                        const idx = ranges.findIndex((r) => score <= r.max);
                        if (idx >= 0) counts[idx]++;
                    }
                });

                Plotly.newPlot(
                    id,
                    [
                        {
                            x: labels,
                            y: counts,
                            type: "bar",
                            marker: { color: ranges.map((r) => r.color) },
                        },
                    ],
                    {
                        title,
                        xaxis: { title: "Score Ranges (%)" },
                        yaxis: { title: "Count" },
                        margin: { t: 40 },
                    }
                );
            };

            const renderCountryAvgChart = (id, scores, title) => {
                const countries = Object.keys(scores);
                const averages = countries.map((c) => +(scores[c].reduce((a, b) => a + b, 0) / scores[c].length).toFixed(2));

                Plotly.newPlot(
                    id,
                    [
                        {
                            x: countries,
                            y: averages,
                            type: "bar",
                            marker: { color: averages.map((s) => getColor(s, title.includes("Part A") ? "partA" : "partB")) },
                        },
                    ],
                    {
                        title,
                        xaxis: { title: "Country" },
                        yaxis: { title: "Average Score (%)", range: [0, 100] },
                        margin: { t: 50, b: 80 },
                    }
                );
            };

            const renderCountryResponseChart = (counts) => {
                const countries = Object.keys(counts);
                const values = countries.map((c) => counts[c]);

                Plotly.newPlot(
                    "countryResponseChart",
                    [
                        {
                            x: countries,
                            y: values,
                            type: "bar",
                            marker: { color: "#2a7a4e" },
                        },
                    ],
                    {
                        title: "Total Form 003 Responses per Country",
                        xaxis: { title: "Country" },
                        yaxis: { title: "Total Responses" },
                        margin: { t: 50, b: 80 },
                    }
                );
            };

            const buildCountryResults = (data) => {
                const results = {};
                data.forEach((d) => {
                    const country = d.form_003_evaluation_country || "Unknown";
                    const scoreA = +d.form_042_PartA_Score || 0;
                    const scoreB = +d.form_044_PartB_Score || 0;
                    const percA = +((scoreA / 70) * 100).toFixed(2);
                    const percB = +((scoreB / 240) * 100).toFixed(2);
                    const colorA = getColorX(percA, "partA");
                    const colorB = getColorX(percB, "partB");

                    if (!results[country]) {
                        results[country] = {
                            partA: { green: 0, yellow: 0, orange: 0, red: 0, total: 0 },
                            partB: { green: 0, yellow: 0, orange: 0, red: 0, total: 0 },
                        };
                    }

                    results[country].partA[colorA]++;
                    results[country].partA.total++;
                    results[country].partB[colorB]++;
                    results[country].partB.total++;
                });
                return results;
            };

            const renderCountryBreakdown = (results) => {
                const container = document.getElementById("countryResults");
                if (!container) return;

                container.innerHTML = "<h3>üåç Score Color Breakdown by Country</h3>";
                const getPct = (count, total) => (total ? ((count / total) * 100).toFixed(1) : "0.0");

                Object.entries(results).forEach(([country, { partA, partB }]) => {
                    const div = document.createElement("div");
                    div.innerHTML = `
        <h4>üåê ${country}</h4>
        <p>Part A: Red(${getPct(partA.red, partA.total)}%) Orange(${getPct(partA.orange, partA.total)}%) Yellow(${getPct(partA.yellow, partA.total)}%) Green(${getPct(partA.green, partA.total)}%)</p>
        <p>Part B: Red(${getPct(partB.red, partB.total)}%) Orange(${getPct(partB.orange, partB.total)}%) Yellow(${getPct(partB.yellow, partB.total)}%) Green(${getPct(partB.green, partB.total)}%)</p>
      `;
                    container.appendChild(div);
                });
            };

            const plotCountryBreakdown = (results) => {
                const countries = Object.keys(results);
                const colors = ["red", "orange", "yellow", "green"];
                const colorHex = {
                    red: "#FF0000",
                    orange: "#FF8C00",
                    yellow: "#FFFC00",
                    green: "#00FF00",
                };
                const colorNames = {
                    red: "üî¥ Red",
                    orange: "üü† Orange",
                    yellow: "üü° Yellow",
                    green: "üü¢ Green",
                };

                const traces = [];

                // For each color, create a bar trace for Part A and Part B
                colors.forEach((color) => {
                    const traceA = {
                        x: countries.map((c) => `${c} - Part A`),
                        y: countries.map((c) => results[c].partA[color] || 0),
                        name: `Part A - ${colorNames[color]}`,
                        type: "bar",
                        marker: { color: colorHex[color] },
                    };
                    const traceB = {
                        x: countries.map((c) => `${c} - Part B`),
                        y: countries.map((c) => results[c].partB[color] || 0),
                        name: `Part B - ${colorNames[color]}`,
                        type: "bar",
                        marker: { color: colorHex[color] },
                    };
                    traces.push(traceA, traceB);
                });

                Plotly.newPlot("colorBreakdownChart", traces, {
                    title: "Color Breakdown by Country and Part",
                    barmode: "group",
                    bargap: 0.05,
                    xaxis: {
                        title: "Country - Part",
                        tickangle: -45,
                    },
                    yaxis: {
                        title: "Number of Responses",
                    },
                    margin: { t: 60, b: 120 },
                });
            };

            processData();
        </script>

        <script>
            let currentAssessments = [];

            const COLORSCC = {
                red: "#FF0000",
                orange: "#FF8C00",
                yellow: "#FFFC00",
                green: "#00FF00",
                default: "#FFFFFF",
            };

            const COLOR_RANGESX = {
                partA: [
                    { range: "0-57", color: COLORS.red },
                    { range: "58-63", color: COLORS.orange },
                    { range: "64-86", color: COLORS.yellow },
                    { range: "87-100", color: COLORS.green },
                ],
                partB: [
                    { range: "0-29", color: COLORS.red },
                    { range: "30-54", color: COLORS.orange },
                    { range: "55-79", color: COLORS.yellow },
                    { range: "80-100", color: COLORS.green },
                ],
            };

            db.collection("nftclientResponses")
                .get()
                .then((snapshot) => {
                    const eventsMap = {};

                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const date = data["form_000_evaluationDate"]?.substring(0, 10);
                        if (!date) return;
                        if (!eventsMap[date]) eventsMap[date] = [];
                        eventsMap[date].push(data);
                    });

                    const events = Object.entries(eventsMap).map(([date, assessments]) => ({
                        title: `${assessments.length} Assessments üìã`,
                        start: date,
                        allDay: true,
                        extendedProps: { assessments },
                    }));

                    const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
                        initialView: "dayGridMonth",
                        height: "auto",
                        events,
                        eventClick: (info) => {
                            currentAssessments = info.event.extendedProps.assessments;
                            const modalBody = document.getElementById("modalBody");
                            modalBody.innerHTML = "";

                            const scoresA = [];
                            const scoresB = [];

                            currentAssessments.forEach((d) => {
                                const scoreA = parseInt(d["form_042_PartA_Score"]) || 0;
                                const scoreB = parseInt(d["form_044_PartB_Score"]) || 0;

                                scoresA.push(scoreA);
                                scoresB.push(scoreB);

                                const colorA = getColorFor(scoreA, "A");
                                const colorB = getColorFor(scoreB, "B");

                                const div = document.createElement("div");
                                div.className = "assessment-entry";
                                div.innerHTML = `
                            <strong>${d["form_005_first-name"] || "User"} ${d["form_006_last-name"] || ""}</strong><br/>
                            Part A: <span class='score' style="background-color: ${colorA}">${scoreA}</span><br/>
                            Part B: <span class='score' style="background-color: ${colorB}">${scoreB}</span>
                        `;
                                modalBody.appendChild(div);
                            });

                            // Show modal first
                            document.getElementById("modal").style.display = "flex";
                            console.log("Modal opened");

                            // Defer chart rendering slightly to ensure modal is fully visible
                            setTimeout(() => {
                                console.log("Rendering charts...");
                                renderColorSummaryChartY(
                                    "partAChart",
                                    scoresA.map((s) => (s / 70) * 100),
                                    "Part A %"
                                );
                                renderColorSummaryChartY(
                                    "partBChart",
                                    scoresB.map((s) => (s / 240) * 100),
                                    "Part B %"
                                );
                            }, 300); // Slight delay to ensure modal is visible
                        },
                    });

                    calendar.render();
                });

            function getColorFor(score, part) {
                const percent = part === "A" ? (score / 70) * 100 : (score / 240) * 100;
                if (part === "A") {
                    if (percent <= 57) return COLORS.red;
                    if (percent <= 63) return COLORS.orange;
                    if (percent <= 86) return COLORS.yellow;
                } else {
                    if (percent <= 29) return COLORS.red;
                    if (percent <= 54) return COLORS.orange;
                    if (percent <= 79) return COLORS.yellow;
                }
                return COLORS.green;
            }

            function getColorLabel(color) {
                return Object.keys(COLORS).find((key) => COLORS[key] === color);
            }

            function downloadPDF() {
                html2canvas(document.getElementById("modalContent")).then((canvas) => {
                    const pdf = new jsPDF();
                    pdf.addImage(canvas.toDataURL("image/png"), "PNG", 10, 10, 180, 160);
                    pdf.save("Assessment_Results.pdf");
                });
            }

            const renderColorSummaryChartY = (id, values, title) => {
                const labels = title.includes("Part A") ? ["0-57", "58-63", "64-86", "87-100"] : ["0-29", "30-54", "55-79", "80-100"];

                const ranges = COLOR_RANGESX[title.includes("Part A") ? "partA" : "partB"];
                const counts = [0, 0, 0, 0];

                values.forEach((val) => {
                    if (title.includes("Part A")) {
                        if (val <= 57) counts[0]++;
                        else if (val <= 63) counts[1]++;
                        else if (val <= 86) counts[2]++;
                        else counts[3]++;
                    } else {
                        if (val <= 29) counts[0]++;
                        else if (val <= 54) counts[1]++;
                        else if (val <= 79) counts[2]++;
                        else counts[3]++;
                    }
                });

                const target = document.getElementById(id); // ‚úÖ Proper variable declaration

                if (!target) {
                    console.error(`Element with ID '${id}' not found.`);
                    return;
                }

                Plotly.newPlot(
                    target,
                    [
                        {
                            x: labels,
                            y: counts,
                            type: "bar",
                            marker: { color: ranges.map((r) => r.color) },
                        },
                    ],
                    {
                        title,
                        xaxis: { title: "Score Range (%)" },
                        yaxis: { title: "Number of Users" },
                        margin: { t: 40 },
                        responsive: true,
                    }
                );
            };
        </script>
<script>
const fetchUserResponses = async () => {
    const snapshot = await db.collection("nftclientResponses").get();
    const userResponses = [];

    const seen = new Set();

    snapshot.forEach((doc) => {
        const data = doc.data();
        const key = [
            data["form_005_first-name"]?.trim().toLowerCase(),
            data["form_006_last-name"]?.trim().toLowerCase(),
            data["form_008_phone"]?.trim()
        ].join("||");

        if (!seen.has(key)) {
            seen.add(key);

            userResponses.push({
                id: doc.id,
                firstName: data["form_005_first-name"] || "Unknown",
                lastName: data["form_006_last-name"] || "Unknown",
                country: data["form_003_evaluation_country"] || "Unknown",
                empstatus: data["form_015_employment"] || "Unspecified",
                institution: data["form_016_employer-name"] || "Unspecified",
                partAScore: +data["form_042_PartA_Score"] || 0,
                partBScore: +data["form_044_PartB_Score"] || 0,
            });
        }
    });

    // Update the table with the user responses
    loadUserResponsesIntoTable(userResponses);
    console.log("üß† Unique User Responses:", userResponses.length);
};

// Function to populate the table with user responses
const loadUserResponsesIntoTable = (userResponses) => {
    const tableBody = document.querySelector("#userTable tbody");
    tableBody.innerHTML = ""; // Clear any existing rows

    userResponses.forEach((response) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${response.firstName} ${response.lastName}</td>
            <td>${response.country}</td>
            <td>${response.empstatus}</td>
            <td>${response.institution}</td>
            <td>${response.partAScore}</td>
            <td>${response.partBScore}</td>
        `;
        tableBody.appendChild(row);
    });
};

// Export to CSV function
const exportUsersCSV = () => {
    const table = document.getElementById("userTable");
    const rows = table.querySelectorAll("tr");
    const csvData = [];
    rows.forEach((row, index) => {
        const rowData = [];
        row.querySelectorAll("td, th").forEach((cell) => {
            rowData.push(cell.innerText.trim());
        });
        csvData.push(rowData.join(","));
    });

    const csvString = csvData.join("\n");
    const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "user_responses.csv";
    link.click();
};

// Call fetchUserResponses when needed to load data



</script>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </body>
</html>
