<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFT Consult Report | Mental Well-being Dashboard</title>
  <link rel="icon" type="image/png" href="logo.jpeg" />

  <!-- External Libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Fix: Correct way to include Font Awesome (use link instead of script) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <!-- Firebase SDKs - Corrected order and script tags for Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>


        <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


  <!-- Styles -->
  <style>
    :root {
      --primary: #4b9a71;
      --secondary: #d35400;
      --bg: #f1f9f4;
      --card-bg: #ffffff;
      --text-color: #444;
      --accent: #8e44ad;
      --border-color: #dfe6e9;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text-color);
    }
    header, .footer {
      background: var(--primary);
      color: #fff;
      text-align: center;
      padding: 1.5rem 2rem;
      font-size: 2rem;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .container {
      padding: 2rem;
    }
    .map-card, .stat-card, .card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .map-card {
      width: 48%;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .map-card:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    .map-header {
      background: var(--primary);
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
    }
    .map-container {
      width: 100%;
      height: 400px;
    }
    .stats-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .stat-card {
      flex: 1;
      min-width: 220px;
      padding: 1.5rem;
    }
    .stat-card h4 { color: #666; font-size: 1.1rem; }
    .stat-card .value { font-size: 2rem; font-weight: bold; color: var(--primary); }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 2rem;
    }
    .card {
      padding: 1rem;
    }
    .card h3 {
      margin-bottom: 1rem;
      color: var(--primary);
    }
    .pill {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      display: inline-block;
      color: #fff;
    }
    .pill.red { background: #e74c3c; }
    .pill.orange { background: #e67e22; }
    .pill.yellow { background: #f1c40f; color: #000; }
    .pill.green { background: var(--secondary); }
    .leaflet-control-attribution { display: none !important; }
  </style>


        <style>
            body {
                font-family: "Poppins", sans-serif;
                margin: 0;
                background: #f4fdf9;
            }
            header {
                background: #2a7a4e;
                color: white;
                padding: 1rem;
                text-align: center;
                font-size: 1.5rem;
                font-weight: bold;
            }
            #calendarContainer {
                padding: 2rem;
                max-width: 1100px;
                margin: auto;
            }
            .fc-daygrid-event {
                background: #065f46;
                color: #fff;
                font-weight: 600;
                padding: 6px 10px;
                border-radius: 10px;
                font-size: 0.85rem;
                text-align: center;
            }
            #modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                justify-content: center;
                align-items: center;
                z-index: 9999;
            }
            #modalContent {
                background: white;
                padding: 2rem;
                border-radius: 16px;
                max-width: 700px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
                position: relative;
            }
            .close-btn {
                position: absolute;
                right: 1rem;
                top: 1rem;
                cursor: pointer;
                font-size: 1.5rem;
            }
            .assessment-entry {
                background: #f0fdfa;
                padding: 1rem;
                margin-bottom: 1rem;
                border-left: 6px solid #2a7a4e;
                border-radius: 12px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            }
            .score {
                font-weight: bold;
                margin-left: 5px;
                padding: 2px 6px;
                border-radius: 6px;
            }
            .low {
                background: #facc15;
                color: #000;
            }
            .medium {
                background: #34d399;
                color: white;
            }
            .high {
                background: #ef4444;
                color: white;
            }
            button {
                background: #2a7a4e;
                color: white;
                padding: 0.5rem 1rem;
                margin-top: 1rem;
                margin-right: 0.5rem;
                border: none;
                border-radius: 8px;
                cursor: pointer;
            }
            canvas {
                max-width: 100%;
                margin-top: 1rem;
            }
        </style>


</head>
<body>
  <header>ðŸ“ˆ NFT Consult - Admin Intelligence Dashboard</header>
  <div class="container">
    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
      <div class="map-card">
        <div class="map-header">Part A Score Map</div>
        <div id="mapPartA" class="map-container"></div>
      </div>
      <div class="map-card">
        <div class="map-header">Part B Score Map</div>
        <div id="mapPartB" class="map-container"></div>
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat-card">
        <h4>Total Responses</h4>
        <div class="value" id="totalResponses">0</div>
      </div>
    </div>

    <div class="dashboard">
      <div class="card">
        <h3>Distribution: Part A</h3>
        <div id="partAChart"></div>
      </div>
      <div class="card">
        <h3>Distribution: Part B</h3>
        <div id="partBChart"></div>
      </div>
    </div>


        <header>Assessment Calendar Dashboard</header>

        <div id="calendarContainer">
            <div id="calendar"></div>
        </div>

        <div id="modal">
            <div id="modalContent">
                <span class="close-btn" onclick="document.getElementById('modal').style.display='none'">&times;</span>
                <h3>Daily Assessments</h3>
                <div id="modalBody"></div>
                <canvas id="partAChart"></canvas>
                <canvas id="partBChart"></canvas>
                <button onclick="downloadPDF()">Download PDF</button>
                <button onclick="sendEmail()">Email Report</button>
            </div>
        </div>

  </div>
  <div class="footer">&copy; 2025 NFT Consult | Powered by Toli Wekka</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDeDsOiA6QP4qbedd_JmQ9na1hM3sf4y3Q",
    authDomain: "mentalhealthtracker-15563.firebaseapp.com",
    projectId: "mentalhealthtracker-15563"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const tileURL = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
  const mapPartA = L.map('mapPartA').setView([0, 0], 2);
  const mapPartB = L.map('mapPartB').setView([0, 0], 2);
  L.tileLayer(tileURL).addTo(mapPartA);
  L.tileLayer(tileURL).addTo(mapPartB);

  const COLOR_RANGES = {
    partA: [
      { max: 57, color: "#FF0000" },
      { max: 63, color: "#FF8C00" },
      { max: 86, color: "#FFFC00" },
      { max: Infinity, color: "#00FF00" }
    ],
    partB: [
      { max: 29, color: "#FF0000" },
      { max: 54, color: "#FF8C00" },
      { max: 79, color: "#FFFC00" },
      { max: Infinity, color: "#00FF00" }
    ]
  };

  const getColor = (score, type) =>
    COLOR_RANGES[type].find(r => score <= r.max).color;

  const geocodeAddress = async (address, country) => {
    if (!address || !country) return null;
    try {
      const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(address + ', ' + country)}&limit=1`;
      const res = await fetch(url);
      const json = await res.json();
      const coords = json?.features?.[0]?.geometry?.coordinates;
      return coords ? { lat: coords[1], lon: coords[0] } : null;
    } catch {
      console.warn("Geocoding failed:", address, country);
      return null;
    }
  };

  const renderMarker = (map, { lat, lon, color, name, address, label }) => {
    L.circleMarker([lat, lon], {
      color,
      fillColor: color,
      fillOpacity: 0.7,
      radius: 10
    }).addTo(map).bindPopup(`
      <b>${name}</b><br>${address}
      <br><span class="pill" style="background-color:${color}">${label}</span>
    `);
  };

  const processData = async () => {
    const snapshot = await db.collection("nftclientResponses").get();
    const docs = snapshot.docs;

    const partA = [], partB = [], markers = [];
    let count = 0;

    await Promise.all(docs.map(async doc => {
      const d = doc.data();
      const address = d.form_002_evaluation_address;
      const country = d.form_003_evaluation_country;
      const name = d.form_005_first_name || "Anonymous";

      const scoreA = +d.form_042_PartA_Score || 0;
      const scoreB = +d.form_044_PartB_Score || 0;
      const percA = +(scoreA / 70 * 100).toFixed(2);
      const percB = +(scoreB / 240 * 100).toFixed(2);

      partA.push(percA);
      partB.push(percB);
      count++;

      if (!address || !country) return;

      const lat = d.geolocation_lat, lon = d.geolocation_lon;
      let coords = lat && lon ? { lat, lon } : await geocodeAddress(address, country);

      if (!coords) return;

      // Update Firestore only if missing
      if (!lat || !lon) {
        await doc.ref.update({ geolocation_lat: coords.lat, geolocation_lon: coords.lon });
      }

      markers.push({ name, address, percA, percB, ...coords });
    }));

    // Render markers
    markers.forEach(({ lat, lon, name, address, percA, percB }) => {
      renderMarker(mapPartA, {
        lat, lon, name, address,
        color: getColor(percA, 'partA'),
        label: `Part A: ${percA}%`
      });

      renderMarker(mapPartB, {
        lat, lon, name, address,
        color: getColor(percB, 'partB'),
        label: `Part B: ${percB}%`
      });
    });

    document.getElementById('totalResponses').innerText = count;
    renderColorSummaryChart('partAChart', partA, 'Part A %');
    renderColorSummaryChart('partBChart', partB, 'Part B %');
  };

  const renderColorSummaryChart = (id, data, title) => {
    // Ensure data is an array
    if (!Array.isArray(data)) {
      console.error("Data is not an array:", data);
      return;
    }

    const ranges = COLOR_RANGES[title.includes("Part A") ? 'partA' : 'partB'];
    const labels = title.includes("Part A")
      ? ["0-57", "58-63", "64-86", "87-100"]
      : ["0-29", "30-54", "55-79", "80-100"];

    const counts = Array(ranges.length).fill(0);
    data.forEach(score => {
      // Ensure score is a valid number
      if (typeof score === 'number' && !isNaN(score)) {
        const idx = ranges.findIndex(r => score <= r.max);
        if (idx >= 0) counts[idx]++;
      } else {
        console.warn("Invalid score encountered:", score);
      }
    });

    Plotly.newPlot(id, [{
      x: labels,
      y: counts,
      type: 'bar',
      marker: { color: ranges.map(r => r.color) }
    }], {
      title,
      xaxis: { title: 'Score Ranges (%)' },
      yaxis: { title: 'Count' },
      margin: { t: 40 }
    });
  };

  // Run once loaded
  processData();
</script>

<script>
  let currentAssessments = [];

  db.collection("nftclientResponses")
    .get()
    .then((snapshot) => {
      const eventsMap = {};
      snapshot.forEach((doc) => {
        const data = doc.data();
        const date = data["form_000_evaluationDate"]?.substring(0, 10);
        if (date) {
          if (!eventsMap[date]) eventsMap[date] = [];
          eventsMap[date].push(data);
        }
      });

      const events = Object.entries(eventsMap).map(([date, assessments]) => ({
        title: `${assessments.length} Assessments ðŸ“‹`,
        start: date,
        allDay: true,
        extendedProps: { assessments },
      }));

      const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
        initialView: "dayGridMonth",
        height: "auto",
        events,
        eventClick: function (info) {
          currentAssessments = info.event.extendedProps.assessments;
          const modalBody = document.getElementById("modalBody");
          modalBody.innerHTML = "";

          const scoresA = [];
          const scoresB = [];
          const colorCountsA = { red: 0, orange: 0, yellow: 0, green: 0 };
          const colorCountsB = { red: 0, orange: 0, yellow: 0, green: 0 };

          currentAssessments.forEach((d) => {
            const scoreA = parseInt(d["form_042_PartA_Score"] || 0);
            const scoreB = parseInt(d["form_044_PartB_Score"] || 0);

            scoresA.push(scoreA);
            scoresB.push(scoreB);

            const colorA = getColorForPartA(scoreA);
            if (colorA === "#FF0000") colorCountsA.red++;
            else if (colorA === "#FF8C00") colorCountsA.orange++;
            else if (colorA === "#FFFC00") colorCountsA.yellow++;
            else if (colorA === "#00FF00") colorCountsA.green++;

            const colorB = getColorForPartB(scoreB);
            if (colorB === "#FF0000") colorCountsB.red++;
            else if (colorB === "#FF8C00") colorCountsB.orange++;
            else if (colorB === "#FFFC00") colorCountsB.yellow++;
            else if (colorB === "#00FF00") colorCountsB.green++;

            const div = document.createElement("div");
            div.className = "assessment-entry";
            div.innerHTML = `<strong>${d["form_005_first-name"] || "User"} ${d["form_006_last-name"] || ""}</strong><br/>
              Part A: <span class='score' style="background-color: ${colorA}">${scoreA}</span><br/>
              Part B: <span class='score' style="background-color: ${colorB}">${scoreB}</span>`;
            modalBody.appendChild(div);
          });

          destroyChart("partAChart");
          destroyChart("partBChart");

          renderColorSummaryChart("partAChart", colorCountsA, "Part A Summary");
          renderColorSummaryChart("partBChart", colorCountsB, "Part B Summary");
          document.getElementById("modal").style.display = "flex";
        },
      });

      calendar.render();
    });

  function getColorForPartA(scoreA) {
    const percA = (scoreA / 70) * 100;
    if (percA >= 0 && percA <= 57) return "#FF0000";
    if (percA > 57 && percA <= 63) return "#FF8C00";
    if (percA > 63 && percA <= 86) return "#FFFC00";
    if (percA > 86 && percA <= 100) return "#00FF00";
    return "#FFFFFF";
  }

  function getColorForPartB(scoreB) {
    const percB = (scoreB / 240) * 100;
    if (percB >= 0 && percB <= 29) return "#FF0000";
    if (percB > 29 && percB <= 54) return "#FF8C00";
    if (percB > 54 && percB <= 79) return "#FFFC00";
    if (percB > 79 && percB <= 100) return "#00FF00";
    return "#FFFFFF";
  }

  function destroyChart(chartId) {
    const chartElement = document.getElementById(chartId);
    if (chartElement) {
      const chartInstance = Chart.getChart(chartId);
      if (chartInstance) {
        chartInstance.destroy();
      }
    }
  }

  function downloadPDF() {
    html2canvas(document.getElementById("modalContent")).then((canvas) => {
      const pdf = new jsPDF();
      pdf.addImage(canvas.toDataURL("image/png"), "PNG", 10, 10, 180, 160);
      pdf.save("Assessment_Results.pdf");
    });
  }
</script>




        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</body>
</html>
