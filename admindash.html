<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>NFT Consult Report | Addressing the Elephant in the Room: A Journey to Mental Well-being</title>
        <link rel="icon" type="image/png" href="logo.jpeg" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>

  <!-- Leaflet.js -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  
  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

  <!-- Custom Styles -->
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8f9fb;
      color: #333;
    }
    header {
      background: #1f3a3d;
      color: #fff;
      padding: 1.5rem 2rem;
      font-size: 2rem;
      text-align: center;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .container {
      padding: 2rem;
    }
    .map-card {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      width: 48%;
      transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      margin-bottom: 2rem;
    }
    .map-card:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    .map-header {
      background: #1f3a3d;
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
    }
    .map-container {
      width: 100%;
      height: 400px;
    }
    .stats-bar {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: #fff;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      flex: 1;
      min-width: 220px;
    }
    .stat-card h4 {
      font-size: 1.1rem;
      color: #666;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: bold;
      color: #1f3a3d;
    }
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 2rem;
    }
    .card {
      background: #fff;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }
    .card h3 {
      margin-bottom: 1rem;
      color: #1f3a3d;
    }
    .footer {
      background: #1f3a3d;
      color: #fff;
      text-align: center;
      padding: 1rem;
      margin-top: 3rem;
    }
    .pill {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      display: inline-block;
      color: #fff;
    }
    .pill.red { background: #e74c3c; }
    .pill.orange { background: #e67e22; }
    .pill.yellow { background: #f1c40f; color: #000; }
    .pill.green { background: #2ecc71; }
    .leaflet-control-attribution {
      display: none !important;
    }
  </style>



<style>
:root {
    --primary: #4b9a71;  /* Lighter, refreshing mint green for the primary color */
    --secondary: #d35400;  /* A darker, complementary color for contrast (burnt orange) */
    --bg: #f1f9f4;         /* Soft minty background color (lighter and softer than before) */
    --card-bg: #ffffff;    /* Clean white for card backgrounds */
    --text-color: #444;    /* Slightly lighter dark gray for text to reduce harshness */
    --accent: #8e44ad;     /* A unique purple accent for variety (used in buttons, links) */
    --border-color: #dfe6e9; /* Light, neutral border color for cards and inputs */
}
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  body {
    font-family: 'Segoe UI', sans-serif;
    background-color: var(--bg); /* Light mint green */
    color: var(--text-color);   /* Dark gray text */
  }
  header {
    background: var(--primary); /* Dark red for header */
    color: #fff;
    padding: 1.5rem 2rem;
    font-size: 2rem;
    text-align: center;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }
  .container {
    padding: 2rem;
  }
  .map-card {
    background: var(--card-bg); /* White card background */
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    width: 48%;
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    margin-bottom: 2rem;
  }
  .map-card:hover {
    transform: scale(1.05);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
  }
  .map-header {
    background: var(--primary); /* Dark red header */
    color: #fff;
    padding: 1rem;
    text-align: center;
    font-size: 1.2rem;
    font-weight: 600;
  }
  .map-container {
    width: 100%;
    height: 400px;
  }
  .stats-bar {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }
  .stat-card {
    background: var(--card-bg); /* White card background */
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    flex: 1;
    min-width: 220px;
  }
  .stat-card h4 {
    font-size: 1.1rem;
    color: #666;
  }
  .stat-card .value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary); /* Dark red for value */
  }
  .dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 2rem;
  }
  .card {
    background: var(--card-bg); /* White card background */
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
  }
  .card h3 {
    margin-bottom: 1rem;
    color: var(--primary); /* Dark red for card headings */
  }
  .footer {
    background: var(--primary); /* Dark red footer */
    color: #fff;
    text-align: center;
    padding: 1rem;
    margin-top: 3rem;
  }
  .pill {
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
    font-size: 0.8rem;
    display: inline-block;
    color: #fff;
  }
  .pill.red { background: #e74c3c; }
  .pill.orange { background: #e67e22; }
  .pill.yellow { background: #f1c40f; color: #000; }
  .pill.green { background: var(--secondary); } /* Mint green for green pills */
  .leaflet-control-attribution {
    display: none !important;
  }
</style>


</head>
<body>
  <header>ðŸ“ˆ NFT Consult - Admin Intelligence Dashboard</header>
  <div class="container">
    <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
      <div class="map-card">
        <div class="map-header">Part A Score Map</div>
        <div id="mapPartA" class="map-container"></div>
      </div>
      <div class="map-card">
        <div class="map-header">Part B Score Map</div>
        <div id="mapPartB" class="map-container"></div>
      </div>
    </div>

    <div class="stats-bar">
      <div class="stat-card">
        <h4>Total Responses</h4>
        <div class="value" id="totalResponses">0</div>
      </div>
    </div>

    <div class="dashboard">
      <div class="card">
        <h3>Distribution: Part A</h3>
        <div id="partAChart"></div>
      </div>
      <div class="card">
        <h3>Distribution: Part B</h3>
        <div id="partBChart"></div>
      </div>
    </div>
  </div>

  <div class="footer">&copy; 2025 NFT Consult | Powered by Toli Wekka</div>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDeDsOiA6QP4qbedd_JmQ9na1hM3sf4y3Q",
    authDomain: "mentalhealthtracker-15563.firebaseapp.com",
    projectId: "mentalhealthtracker-15563"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const mapPartA = L.map('mapPartA').setView([0, 0], 2);
  const mapPartB = L.map('mapPartB').setView([0, 0], 2);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(mapPartA);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(mapPartB);

  function getColorForPartA(p) {
    if (p <= 57) return "#FF0000";
    if (p <= 63) return "#FF8C00";
    if (p <= 86) return "#FFFC00";
    return "#00FF00";
  }

  function getColorForPartB(p) {
    if (p <= 29) return "#FF0000";
    if (p <= 54) return "#FF8C00";
    if (p <= 79) return "#FFFC00";
    return "#00FF00";
  }

  async function geocodeAddress(address, country) {
    const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(address + ', ' + country)}&limit=1`;
    try {
      const res = await fetch(url);
      const json = await res.json();
      if (json.features?.[0]) {
        const [lon, lat] = json.features[0].geometry.coordinates;
        return { lat, lon };
      }
    } catch (e) {
      console.warn("Geocode failed:", address, country);
    }
    return null;
  }

  db.collection("nftclientResponses").get().then(async snapshot => {
    const partA = [], partB = [], geocodedMarkers = [];
    let count = 0;

    const docs = snapshot.docs;

    const promises = docs.map(async doc => {
      const d = doc.data();
      const address = d.form_002_evaluation_address || "";
      const country = d.form_003_evaluation_country || "";
      const name = d.form_005_first_name || "Anonymous";
      const scoreA = d.form_042_PartA_Score || 0;
      const scoreB = d.form_044_PartB_Score || 0;
      const percA = parseFloat(((scoreA / 70) * 100).toFixed(2));
      const percB = parseFloat(((scoreB / 240) * 100).toFixed(2));

      partA.push(percA);
      partB.push(percB);
      count++;

      if (!address || !country) return;

      const coords = await geocodeAddress(address, country);
      if (!coords) return;

      // Update Firestore only if needed
      if (!d.geolocation_lat || !d.geolocation_lon) {
        await doc.ref.update({
          geolocation_lat: coords.lat,
          geolocation_lon: coords.lon
        });
      }

      geocodedMarkers.push({
        name,
        address,
        percA,
        percB,
        lat: coords.lat,
        lon: coords.lon
      });
    });

    // Wait for all geocoding & Firestore updates to complete
    await Promise.all(promises);

    // Render markers after batch is complete
    geocodedMarkers.forEach(({ name, address, percA, percB, lat, lon }) => {
      L.circleMarker([lat, lon], {
        color: getColorForPartA(percA),
        fillColor: getColorForPartA(percA),
        fillOpacity: 0.7,
        radius: 10
      }).addTo(mapPartA).bindPopup(
        `<b>${name}</b><br>${address}<br><span class="pill" style="background-color:${getColorForPartA(percA)}">Part A: ${percA}%</span>`
      );

      L.circleMarker([lat, lon], {
        color: getColorForPartB(percB),
        fillColor: getColorForPartB(percB),
        fillOpacity: 0.7,
        radius: 10
      }).addTo(mapPartB).bindPopup(
        `<b>${name}</b><br>${address}<br><span class="pill" style="background-color:${getColorForPartB(percB)}">Part B: ${percB}%</span>`
      );
    });

    // Update UI
    document.getElementById('totalResponses').innerText = count;
    renderColorSummaryChart('partAChart', partA, 'Part A %');
    renderColorSummaryChart('partBChart', partB, 'Part B %');
  });

  function renderColorSummaryChart(id, data, title) {
    const ranges = title.includes("Part A")
      ? [
        { label: "0-57", min: 0, max: 57, color: "#FF0000" },
        { label: "58-63", min: 58, max: 63, color: "#FF8C00" },
        { label: "64-86", min: 64, max: 86, color: "#FFFC00" },
        { label: "87-100", min: 87, max: 100, color: "#00FF00" }
      ]
      : [
        { label: "0-29", min: 0, max: 29, color: "#FF0000" },
        { label: "30-54", min: 30, max: 54, color: "#FF8C00" },
        { label: "55-79", min: 55, max: 79, color: "#FFFC00" },
        { label: "80-100", min: 80, max: 100, color: "#00FF00" }
      ];

    const counts = new Array(ranges.length).fill(0);
    data.forEach(score => {
      for (let i = 0; i < ranges.length; i++) {
        if (score >= ranges[i].min && score <= ranges[i].max) {
          counts[i]++;
          break;
        }
      }
    });

    Plotly.newPlot(id, [{
      x: ranges.map(r => r.label),
      y: counts,
      type: 'bar',
      marker: { color: ranges.map(r => r.color) }
    }], {
      title: title,
      xaxis: { title: 'Score Ranges (%)' },
      yaxis: { title: 'Count' },
      margin: { t: 40 }
    });
  }
</script>
</body>
</html>
