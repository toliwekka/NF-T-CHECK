<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>NFT Consult Report | Mental Well-being Dashboard</title>
        <link rel="icon" type="image/png" href="logo.jpeg" />

        <!-- External Libraries -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

        <!-- Fix: Correct way to include Font Awesome (use link instead of script) -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

        <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

        <!-- Firebase SDKs - Corrected order and script tags for Firebase -->
        <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>

        <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- Load Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- Add Bootstrap -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
        <!-- Bootstrap & Fonts -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet" />



        <!-- Styles -->
        <style>
    :root {
        --primary: #2a7a4e;
        --secondary: #44b78b;
        --bg: #f4fdf9;
        --card-bg: #ffffff;
        --footer-bg: #930d0e;
        --accent: #16a085;
        --text-color: #444;
        --glass: rgba(255, 255, 255, 0.65);
        --highlight: #d0f5e0;
        --border-color: #dfe6e9;
        --danger: #e74c3c;
        --warning: #f1c40f;
        --info: #34d399;
    }
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                font-family: "Segoe UI", sans-serif;
                background-color: var(--bg);
                color: var(--text-color);
            }
            header,
            .footer {
                background: var(--primary);
                color: #fff;
                text-align: center;
                padding: 1.5rem 2rem;
                font-size: 2rem;
                font-weight: 600;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            }
            .container {
                padding: 2rem;
            }
            .map-card,
            .stat-card,
            .card {
                background: var(--card-bg);
                border-radius: 12px;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
                margin-bottom: 2rem;
            }
            .map-card {
                width: 48%;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .map-card:hover {
                transform: scale(1.05);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            }
            .map-header {
                background: var(--primary);
                color: #fff;
                padding: 1rem;
                text-align: center;
                font-size: 1.2rem;
                font-weight: 600;
            }
            .map-container {
                width: 100%;
                height: 400px;
            }
            .stats-bar {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
            }
            .stat-card {
                flex: 1;
                min-width: 220px;
                padding: 1.5rem;
            }
            .stat-card h4 {
                color: #666;
                font-size: 1.1rem;
            }
            .stat-card .value {
                font-size: 2rem;
                font-weight: bold;
                color: var(--primary);
            }
            .dashboard {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                gap: 2rem;
            }
            .card {
                padding: 1rem;
            }
            .card h3 {
                margin-bottom: 1rem;
                color: var(--primary);
            }
            .pill {
                padding: 0.2rem 0.6rem;
                border-radius: 999px;
                font-size: 0.8rem;
                display: inline-block;
                color: #fff;
            }
            .pill.red {
                background: #e74c3c;
            }
            .pill.orange {
                background: #e67e22;
            }
            .pill.yellow {
                background: #f1c40f;
                color: #000;
            }
            .pill.green {
                background: var(--secondary);
            }
            .leaflet-control-attribution {
                display: none !important;
            }
        </style>

        <style>
            body {
                font-family: "Poppins", sans-serif;
                margin: 0;
                background: #f4fdf9;
            }
            header {
                background: #2a7a4e;
                color: white;
                padding: 1rem;
                text-align: center;
                font-size: 1.5rem;
                font-weight: bold;
            }
            #calendarContainer {
                padding: 2rem;
                max-width: 1100px;
                margin: auto;
            }
            .fc-daygrid-event {
                background: #065f46;
                color: #fff;
                font-weight: 600;
                padding: 6px 10px;
                border-radius: 10px;
                font-size: 0.85rem;
                text-align: center;
            }
            #modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                justify-content: center;
                align-items: center;
                z-index: 9999;
            }
            #modalContent {
                background: white;
                padding: 2rem;
                border-radius: 16px;
                max-width: 700px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
                position: relative;
            }
            .close-btn {
                position: absolute;
                right: 1rem;
                top: 1rem;
                cursor: pointer;
                font-size: 1.5rem;
            }
            .assessment-entry {
                background: #f0fdfa;
                padding: 1rem;
                margin-bottom: 1rem;
                border-left: 6px solid #2a7a4e;
                border-radius: 12px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            }
            .score {
                font-weight: bold;
                margin-left: 5px;
                padding: 2px 6px;
                border-radius: 6px;
            }
            .low {
                background: #facc15;
                color: #000;
            }
            .medium {
                background: #34d399;
                color: white;
            }
            .high {
                background: #ef4444;
                color: white;
            }
            button {
                background: #2a7a4e;
                color: white;
                padding: 0.5rem 1rem;
                margin-top: 1rem;
                margin-right: 0.5rem;
                border: none;
                border-radius: 8px;
                cursor: pointer;
            }
            canvas {
                max-width: 100%;
                margin-top: 1rem;
            }
        </style>











<!-- Styles -->
<style>

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(to bottom, var(--bg), #e6f5ed);
        color: var(--text-color);
        overflow-x: hidden;
        padding-top: 4rem;
    }

    header {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 2rem;
        text-align: center;
        font-size: 2rem;
        font-weight: bold;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .glass-card {
        background: var(--glass);
        backdrop-filter: blur(8px);
        border-radius: 1.5rem;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
    }

    .glass-card:hover {
        transform: scale(1.02);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .stat-box {
        background: var(--highlight);
        border-left: 6px solid var(--primary);
        padding: 1.25rem;
        border-radius: 1rem;
        font-size: 1.1rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease;
    }

    .stat-box:hover {
        transform: scale(1.02);
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
    }

    .map-container,
    .chart-container,
    .calendar-container {
        height: 400px;
        border-radius: 1rem;
        overflow: hidden;
        margin-bottom: 2rem;
        background-color: var(--card-bg);
    }

    .footer {
        background: var(--footer-bg);
        color: white;
        text-align: center;
        padding: 1.5rem 1rem;
        margin-top: 4rem;
        font-size: 1rem;
    }

    button {
        background-color: var(--primary);
        color: white;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
    }

    button:hover {
        background-color: var(--secondary);
    }

    .pill {
        padding: 0.2rem 0.6rem;
        border-radius: 999px;
        font-size: 0.8rem;
        display: inline-block;
        color: white;
    }

    .pill.danger {
        background: var(--danger);
    }

    .pill.warning {
        background: var(--warning);
        color: #000;
    }

    .pill.info {
        background: var(--info);
    }
</style>

<style>
    :root {
        --primary: #2a7a4e;
        --secondary: #44b78b;
        --bg: #f4fdf9;
        --card-bg: #ffffff;
        --footer-bg: #930d0e;
        --accent: #16a085;
        --text-color: #444;
        --glass: rgba(255, 255, 255, 0.75);
        --highlight: #d0f5e0;
        --border-color: #dfe6e9;
        --danger: #e74c3c;
        --warning: #f1c40f;
        --info: #34d399;
        --shadow: rgba(0, 0, 0, 0.1);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(to bottom, var(--bg), #e6f5ed);
        color: var(--text-color);
        padding: 0;
        margin: 0;
    }

    header {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 2rem;
        text-align: center;
        font-size: 2.5rem;
        font-weight: bold;
        box-shadow: 0 8px 20px var(--shadow);
    }

    .container {
        max-width: 1200px;
        margin: auto;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .glass-card {
        background: var(--glass);
        backdrop-filter: blur(10px);
        border-radius: 1.5rem;
        box-shadow: 0 8px 30px var(--shadow);
        padding: 2rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .glass-card:hover {
        transform: scale(1.03);
        box-shadow: 0 12px 40px var(--shadow);
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 2rem;
    }

    .card {
        background: var(--card-bg);
        border-radius: 1.5rem;
        box-shadow: 0 4px 15px var(--shadow);
        padding: 1.5rem;
        transition: transform 0.3s ease;
    }

    .card:hover {
        transform: translateY(-10px);
        box-shadow: 0 8px 25px var(--shadow);
    }

    .stat-box {
        background: var(--highlight);
        padding: 1.5rem;
        border-left: 6px solid var(--primary);
        border-radius: 1rem;
        font-size: 1.2rem;
        box-shadow: 0 4px 15px var(--shadow);
        transition: transform 0.3s ease;
    }

    .stat-box:hover {
        transform: scale(1.02);
    }

    .map-container,
    .chart-container,
    .calendar-container {
        height: 400px;
        border-radius: 1rem;
        overflow: hidden;
        background-color: var(--card-bg);
        box-shadow: 0 4px 15px var(--shadow);
    }

    button {
        background-color: var(--primary);
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

    button:hover {
        background-color: var(--secondary);
        transform: translateY(-3px);
    }

    .footer {
        background: var(--footer-bg);
        color: white;
        text-align: center;
        padding: 2rem 1rem;
        font-size: 1rem;
        box-shadow: 0 -4px 10px var(--shadow);
    }

    .pill {
        padding: 0.4rem 0.8rem;
        border-radius: 999px;
        font-size: 0.9rem;
        display: inline-block;
        font-weight: bold;
    }

    .pill.danger {
        background: var(--danger);
        color: white;
    }

    .pill.warning {
        background: var(--warning);
        color: black;
    }

    .pill.info {
        background: var(--info);
        color: white;
    }




.group-header {
  background-color: #e0e0e0;
  font-weight: bold;
  font-size: 1rem;
}

</style>
    </head>
    <body>
        <header>
            NFT Consult Mental Well-Being Dashboard
        </header>

        <div id="sidebar" class="position-fixed top-0 start-0 h-100 bg-white shadow-lg p-3 d-flex flex-column" style="width: 220px; z-index: 1040;">
            <h5 class="text-success fw-bold mb-4">NFT Admin</h5>
            <a href="#mapPartA" class="mb-2 text-decoration-none text-dark">üåç Affective Map</a>
            <a href="#mapPartB" class="mb-2 text-decoration-none text-dark">üß† Functional Map</a>
            <a href="#countryResponseChart" class="mb-2 text-decoration-none text-dark">üìä Country Chart</a>
            <a href="#calendar" class="mb-2 text-decoration-none text-dark">üìÖ Calendar</a>
            <a href="#userListSection" class="mb-2 text-decoration-none text-dark">üë§ Users</a>
            <a href="#" class="mt-auto btn btn-outline-danger" onclick="logoutAdmin()">Logout</a>
        </div>

        <main class="container py-4">
            <div class="dashboard-grid">
                <div class="glass-card">
                    <div class="section-title">Map: Affective Well-being Scale Pulse A</div>
                    <div id="mapPartA" class="map-container"></div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="glass-card">
                    <div class="section-title">Map: Functional Well-being Scale Pulse B</div>
                    <div id="mapPartB" class="map-container"></div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-box text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <div><strong>Total Responses</strong></div>
                    <div id="totalResponses" class="display-6">0</div>
                </div>
            </div>

            <div class="glass-card">
                <div class="section-title">Response Chart by Country</div>
                <div id="countryResponseChart" class="chart-container"></div>
            </div>

            <div class="glass-card">
                <div class="section-title">Color Breakdown by Country</div>
                <div id="colorBreakdownChart" style="width: 100%; height: 500px;"></div>
            </div>

            <div class="glass-card">
                <div class="section-title">Calendar of Activities</div>
                <div id="calendar" class="calendar-container"></div>
                <div id="modal">
                    <div id="modalContent">
                        <span class="close-btn" onclick="document.getElementById('modal').style.display='none'">&times;</span>
                        <h3>Daily Assessments</h3>
                        <div id="modalBody"></div>
                        <div id="partAChart" style="width: 100%; height: 400px;"></div>
                        <div id="partBChart" style="width: 100%; height: 400px;"></div>
                        <button onclick="downloadPDF()">Download PDF</button>
                        <button onclick="sendEmail()">Email Report</button>
                    </div>
                </div>
            </div>

            <!-- NEW: User List Table -->
            <div class="glass-card" id="userListSection">
                <div class="section-title">üë§ User Responses</div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="userTable">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Country</th>
                                <th>Employment Status</th>
                                <th>Institution</th>
                                <th>Score A</th>
                                <th>Score B</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button class="btn btn-success mt-2" onclick="exportUsersCSV()">Export CSV</button>
            </div>


        </main>

        <footer class="footer">
            &copy; 2025 NFT Consult | Powered by Toli Wekka
        </footer>

        <!-- Bootstrap & Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

        <div class="container">
            <div class="dashboard" style="display: none;" ;>
                <div class="card" style="display: none;" ;>
                    <h3>Average Score by Country: Part A</h3>
                    <div id="countryPartAChart"></div>
                </div>
                <div class="card">
                    <h3>Average Score by Country: Part B</h3>
                    <div id="countryPartBChart"></div>
                </div>
            </div>

            <div class="dashboard" style="display: none;" ;>
                <div class="card">
                    <h3>Distribution: Part A</h3>
                    <div id="partAChart"></div>
                </div>
                <div class="card">
                    <h3>Distribution: Part B</h3>
                    <div id="partBChart"></div>
                </div>
            </div>
        </div>

        <script>
            const firebaseConfig = {
                apiKey: "AIzaSyDeDsOiA6QP4qbedd_JmQ9na1hM3sf4y3Q",
                authDomain: "mentalhealthtracker-15563.firebaseapp.com",
                projectId: "mentalhealthtracker-15563",
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            const mapPartA = L.map("mapPartA").setView([0, 0], 2);
            const mapPartB = L.map("mapPartB").setView([0, 0], 2);
            L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png").addTo(mapPartA);
            L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png").addTo(mapPartB);

            const COLOR_RANGES = {
                partA: [
                    { max: 57, color: "#FF0000" },
                    { max: 63, color: "#FF8C00" },
                    { max: 86, color: "#FFFC00" },
                    { max: Infinity, color: "#00FF00" },
                ],
                partB: [
                    { max: 29, color: "#FF0000" },
                    { max: 54, color: "#FF8C00" },
                    { max: 79, color: "#FFFC00" },
                    { max: Infinity, color: "#00FF00" },
                ],
            };

            const COLOR_RANGESXX = {
                partA: [
                    { min: 0, max: 57, color: "red" },
                    { min: 58, max: 63, color: "orange" },
                    { min: 64, max: 86, color: "yellow" },
                    { min: 87, max: 100, color: "green" },
                ],
                partB: [
                    { min: 0, max: 29, color: "red" },
                    { min: 30, max: 54, color: "orange" },
                    { min: 55, max: 79, color: "yellow" },
                    { min: 80, max: 100, color: "green" },
                ],
            };

            const COLORS = {
                red: "#ff4d4d",
                orange: "#ffa500",
                yellow: "#ffff66",
                green: "#66cc66",
            };

            const getColor = (score, type) => COLOR_RANGES[type].find((r) => score <= r.max).color;
            const getColorX = (score, part) => COLOR_RANGESXX[part].find((r) => score >= r.min && score <= r.max)?.color || "unknown";

            const geocodeAddress = async (address, country) => {
                if (!address || !country) return null;
                try {
                    const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(address + ", " + country)}&limit=1`;
                    const res = await fetch(url);
                    const json = await res.json();
                    const coords = json?.features?.[0]?.geometry?.coordinates;
                    return coords ? { lat: coords[1], lon: coords[0] } : null;
                } catch {
                    console.warn("Geocoding failed:", address, country);
                    return null;
                }
            };

            const renderMarker = (map, { lat, lon, color, name, address, label }) => {
                L.circleMarker([lat, lon], {
                    color,
                    fillColor: color,
                    fillOpacity: 0.7,
                    radius: 10,
                })
                    .addTo(map)
                    .bindPopup(`<b>${name}</b><br>${address}<br><span class="pill" style="background-color:${color}">${label}</span>`);
            };

            const processData = async () => {
                const snapshot = await db.collection("nftclientResponses").get();
                const docs = snapshot.docs.map((doc) => ({ id: doc.id, ref: doc.ref, ...doc.data() }));

                const partA = [],
                    partB = [],
                    markers = [];
                let count = 0;
                const countryScoresA = {},
                    countryScoresB = {},
                    countryCounts = {};

                const uniqueMap = new Map();

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const key = [data.form_005_first_name?.trim().toLowerCase(), data.form_006_last_name?.trim().toLowerCase(), data.form_008_phone?.trim()].join("||");

                    if (!uniqueMap.has(key)) {
                        uniqueMap.set(key, { id: doc.id, ...data });

                        const country = data.form_003_evaluation_country?.trim().toLowerCase() || "unknown";

                        if (!countryCounts[country]) {
                            countryCounts[country] = 1;
                        } else {
                            countryCounts[country]++;
                        }
                    }
                });

                count = uniqueMap.size;
                console.log("Unique Responses:", count);
                console.log("Breakdown by Country:", countryCounts);

                await Promise.all(
                    docs.map(async (d) => {
                        const { form_016_employment: institution, form_002_evaluation_address: address, form_003_evaluation_country: country } = d;
                        const name = d["form_005_first-name"] || "Anonymous";

                        const scoreA = Number(d.form_042_PartA_Score) || 0;
                        const scoreB = Number(d.form_044_PartB_Score) || 0;
                        const percA = +((scoreA / 70) * 100).toFixed(2);
                        const percB = +((scoreB / 240) * 100).toFixed(2);

                        partA.push(percA);
                        partB.push(percB);

                        if (!address || !country) return;

                        let { geolocation_lat: lat, geolocation_lon: lon } = d;
                        let coords = lat && lon ? { lat, lon } : await geocodeAddress(address, country);

                        if (!coords) return;
                        if (!lat || !lon) {
                            await d.ref.update({
                                geolocation_lat: coords.lat,
                                geolocation_lon: coords.lon,
                            });
                        }

                        // include both raw scores
                        markers.push({ name, address, scoreA, scoreB, percA, percB, ...coords });
                    })
                );

                // now destructuring includes scoreA and scoreB:
                markers.forEach(({ lat, lon, name, address, scoreA, scoreB, percA, percB }) => {
                    renderMarker(mapPartA, {
                        lat,
                        lon,
                        name,
                        address,
                        color: getColor(percA, "partA"),
                        // show both raw and percent
                        label: `Part A: ${scoreA} (${percA}%)`,
                    });
                    renderMarker(mapPartB, {
                        lat,
                        lon,
                        name,
                        address,
                        color: getColor(percB, "partB"),
                        label: `Part B: ${scoreB} (${percB}%)`,
                    });
                });

                document.getElementById("totalResponses").innerText = count;
                renderCountryResponseChart(countryCounts);
                renderColorSummaryChart("partAChart", partA, "Part A %");
                renderColorSummaryChart("partBChart", partB, "Part B %");
                renderCountryAvgChart("countryPartAChart", countryScoresA, "Average Part A % by Country");
                renderCountryAvgChart("countryPartBChart", countryScoresB, "Average Part B % by Country");

                const resultsByCountry = buildCountryResults(docs);
                console.log("Breakdown by Country:", resultsByCountry);

                renderCountryBreakdown(resultsByCountry);
                plotCountryBreakdown(resultsByCountry);
                fetchUserResponses();
            };

            const renderColorSummaryChart = (id, data, title) => {
                const ranges = COLOR_RANGES[title.includes("Part A") ? "partA" : "partB"];
                const labels = title.includes("Part A") ? ["0-57", "58-63", "64-86", "87-100"] : ["0-29", "30-54", "55-79", "80-100"];
                const counts = Array(ranges.length).fill(0);

                data.forEach((score) => {
                    if (!isNaN(score)) {
                        const idx = ranges.findIndex((r) => score <= r.max);
                        if (idx >= 0) counts[idx]++;
                    }
                });

                Plotly.newPlot(
                    id,
                    [
                        {
                            x: labels,
                            y: counts,
                            type: "bar",
                            marker: { color: ranges.map((r) => r.color) },
                        },
                    ],
                    {
                        title,
                        xaxis: { title: "Score Ranges (%)" },
                        yaxis: { title: "Count" },
                        margin: { t: 40 },
                    }
                );
            };

            const renderCountryAvgChart = (id, scores, title) => {
                const countries = Object.keys(scores);
                const averages = countries.map((c) => +(scores[c].reduce((a, b) => a + b, 0) / scores[c].length).toFixed(2));

                Plotly.newPlot(
                    id,
                    [
                        {
                            x: countries,
                            y: averages,
                            type: "bar",
                            marker: { color: averages.map((s) => getColor(s, title.includes("Part A") ? "partA" : "partB")) },
                        },
                    ],
                    {
                        title,
                        xaxis: { title: "Country" },
                        yaxis: { title: "Average Score (%)", range: [0, 100] },
                        margin: { t: 50, b: 80 },
                    }
                );
            };

            const renderCountryResponseChart = (counts) => {
                const countries = Object.keys(counts);
                const values = countries.map((c) => counts[c]);

                Plotly.newPlot(
                    "countryResponseChart",
                    [
                        {
                            x: countries,
                            y: values,
                            type: "bar",
                            marker: { color: "#2a7a4e" },
                        },
                    ],
                    {
                        title: "Total Form 003 Responses per Country",
                        xaxis: { title: "Country" },
                        yaxis: { title: "Total Responses" },
                        margin: { t: 50, b: 80 },
                    }
                );
            };

            const buildCountryResults = (data) => {
                const results = {};
                data.forEach((d) => {
                    const country = d.form_003_evaluation_country || "Unknown";
                    const scoreA = +d.form_042_PartA_Score || 0;
                    const scoreB = +d.form_044_PartB_Score || 0;
                    const percA = +((scoreA / 70) * 100).toFixed(2);
                    const percB = +((scoreB / 240) * 100).toFixed(2);
                    const colorA = getColorX(percA, "partA");
                    const colorB = getColorX(percB, "partB");

                    if (!results[country]) {
                        results[country] = {
                            partA: { green: 0, yellow: 0, orange: 0, red: 0, total: 0 },
                            partB: { green: 0, yellow: 0, orange: 0, red: 0, total: 0 },
                        };
                    }

                    results[country].partA[colorA]++;
                    results[country].partA.total++;
                    results[country].partB[colorB]++;
                    results[country].partB.total++;
                });
                return results;
            };

            const renderCountryBreakdown = (results) => {
                const container = document.getElementById("countryResults");
                if (!container) return;

                container.innerHTML = "<h3>üåç Score Color Breakdown by Country</h3>";
                const getPct = (count, total) => (total ? ((count / total) * 100).toFixed(1) : "0.0");

                Object.entries(results).forEach(([country, { partA, partB }]) => {
                    const div = document.createElement("div");
                    div.innerHTML = `
        <h4>üåê ${country}</h4>
        <p>Part A: Red(${getPct(partA.red, partA.total)}%) Orange(${getPct(partA.orange, partA.total)}%) Yellow(${getPct(partA.yellow, partA.total)}%) Green(${getPct(partA.green, partA.total)}%)</p>
        <p>Part B: Red(${getPct(partB.red, partB.total)}%) Orange(${getPct(partB.orange, partB.total)}%) Yellow(${getPct(partB.yellow, partB.total)}%) Green(${getPct(partB.green, partB.total)}%)</p>
      `;
                    container.appendChild(div);
                });
            };

            const plotCountryBreakdown = (results) => {
                const countries = Object.keys(results);
                const colors = ["red", "orange", "yellow", "green"];
                const colorHex = {
                    red: "#FF0000",
                    orange: "#FF8C00",
                    yellow: "#FFFC00",
                    green: "#00FF00",
                };
                const colorNames = {
                    red: "üî¥ Red",
                    orange: "üü† Orange",
                    yellow: "üü° Yellow",
                    green: "üü¢ Green",
                };

                const traces = [];

                // For each color, create a bar trace for Part A and Part B
                colors.forEach((color) => {
                    const traceA = {
                        x: countries.map((c) => `${c} - Part A`),
                        y: countries.map((c) => results[c].partA[color] || 0),
                        name: `Part A - ${colorNames[color]}`,
                        type: "bar",
                        marker: { color: colorHex[color] },
                    };
                    const traceB = {
                        x: countries.map((c) => `${c} - Part B`),
                        y: countries.map((c) => results[c].partB[color] || 0),
                        name: `Part B - ${colorNames[color]}`,
                        type: "bar",
                        marker: { color: colorHex[color] },
                    };
                    traces.push(traceA, traceB);
                });

                Plotly.newPlot("colorBreakdownChart", traces, {
                    title: "Color Breakdown by Country and Part",
                    barmode: "group",
                    bargap: 0.05,
                    xaxis: {
                        title: "Country - Part",
                        tickangle: -45,
                    },
                    yaxis: {
                        title: "Number of Responses",
                    },
                    margin: { t: 60, b: 120 },
                });
            };

            processData();
        </script>

        <script>
            let currentAssessments = [];

            const COLORSCC = {
                red: "#FF0000",
                orange: "#FF8C00",
                yellow: "#FFFC00",
                green: "#00FF00",
                default: "#FFFFFF",
            };

            const COLOR_RANGESX = {
                partA: [
                    { range: "0-57", color: COLORS.red },
                    { range: "58-63", color: COLORS.orange },
                    { range: "64-86", color: COLORS.yellow },
                    { range: "87-100", color: COLORS.green },
                ],
                partB: [
                    { range: "0-29", color: COLORS.red },
                    { range: "30-54", color: COLORS.orange },
                    { range: "55-79", color: COLORS.yellow },
                    { range: "80-100", color: COLORS.green },
                ],
            };

            db.collection("nftclientResponses")
                .get()
                .then((snapshot) => {
                    const eventsMap = {};

                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const date = data["form_000_evaluationDate"]?.substring(0, 10);
                        if (!date) return;
                        if (!eventsMap[date]) eventsMap[date] = [];
                        eventsMap[date].push(data);
                    });

                    const events = Object.entries(eventsMap).map(([date, assessments]) => ({
                        title: `${assessments.length} Assessments üìã`,
                        start: date,
                        allDay: true,
                        extendedProps: { assessments },
                    }));

                    const calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
                        initialView: "dayGridMonth",
                        height: "auto",
                        events,
                        eventClick: (info) => {
                            currentAssessments = info.event.extendedProps.assessments;
                            const modalBody = document.getElementById("modalBody");
                            modalBody.innerHTML = "";

                            const scoresA = [];
                            const scoresB = [];

                            currentAssessments.forEach((d) => {
                                const scoreA = parseInt(d["form_042_PartA_Score"]) || 0;
                                const scoreB = parseInt(d["form_044_PartB_Score"]) || 0;

                                scoresA.push(scoreA);
                                scoresB.push(scoreB);

                                const colorA = getColorFor(scoreA, "A");
                                const colorB = getColorFor(scoreB, "B");

                                const div = document.createElement("div");
                                div.className = "assessment-entry";
                                div.innerHTML = `
                            <strong>${d["form_005_first-name"] || "User"} ${d["form_006_last-name"] || ""}</strong><br/>
                            Part A: <span class='score' style="background-color: ${colorA}">${scoreA}</span><br/>
                            Part B: <span class='score' style="background-color: ${colorB}">${scoreB}</span>
                        `;
                                modalBody.appendChild(div);
                            });

                            // Show modal first
                            document.getElementById("modal").style.display = "flex";
                            console.log("Modal opened");

                            // Defer chart rendering slightly to ensure modal is fully visible
                            setTimeout(() => {
                                console.log("Rendering charts...");
                                renderColorSummaryChartY(
                                    "partAChart",
                                    scoresA.map((s) => (s / 70) * 100),
                                    "Part A %"
                                );
                                renderColorSummaryChartY(
                                    "partBChart",
                                    scoresB.map((s) => (s / 240) * 100),
                                    "Part B %"
                                );
                            }, 300); // Slight delay to ensure modal is visible
                        },
                    });

                    calendar.render();
                });

            function getColorFor(score, part) {
                const percent = part === "A" ? (score / 70) * 100 : (score / 240) * 100;
                if (part === "A") {
                    if (percent <= 57) return COLORS.red;
                    if (percent <= 63) return COLORS.orange;
                    if (percent <= 86) return COLORS.yellow;
                } else {
                    if (percent <= 29) return COLORS.red;
                    if (percent <= 54) return COLORS.orange;
                    if (percent <= 79) return COLORS.yellow;
                }
                return COLORS.green;
            }

            function getColorLabel(color) {
                return Object.keys(COLORS).find((key) => COLORS[key] === color);
            }

            function downloadPDF() {
                html2canvas(document.getElementById("modalContent")).then((canvas) => {
                    const pdf = new jsPDF();
                    pdf.addImage(canvas.toDataURL("image/png"), "PNG", 10, 10, 180, 160);
                    pdf.save("Assessment_Results.pdf");
                });
            }

            const renderColorSummaryChartY = (id, values, title) => {
                const labels = title.includes("Part A") ? ["0-57", "58-63", "64-86", "87-100"] : ["0-29", "30-54", "55-79", "80-100"];

                const ranges = COLOR_RANGESX[title.includes("Part A") ? "partA" : "partB"];
                const counts = [0, 0, 0, 0];

                values.forEach((val) => {
                    if (title.includes("Part A")) {
                        if (val <= 57) counts[0]++;
                        else if (val <= 63) counts[1]++;
                        else if (val <= 86) counts[2]++;
                        else counts[3]++;
                    } else {
                        if (val <= 29) counts[0]++;
                        else if (val <= 54) counts[1]++;
                        else if (val <= 79) counts[2]++;
                        else counts[3]++;
                    }
                });

                const target = document.getElementById(id); // ‚úÖ Proper variable declaration

                if (!target) {
                    console.error(`Element with ID '${id}' not found.`);
                    return;
                }

                Plotly.newPlot(
                    target,
                    [
                        {
                            x: labels,
                            y: counts,
                            type: "bar",
                            marker: { color: ranges.map((r) => r.color) },
                        },
                    ],
                    {
                        title,
                        xaxis: { title: "Score Range (%)" },
                        yaxis: { title: "Number of Users" },
                        margin: { t: 40 },
                        responsive: true,
                    }
                );
            };
        </script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDeDsOiA6QP4qbedd_JmQ9na1hM3sf4y3Q",
    authDomain: "mentalhealthtracker-15563.firebaseapp.com",
    projectId: "mentalhealthtracker-15563",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  let chartInstances = {};

  // Normalize helper
  const normalize = (str) => (str || "").trim().toLowerCase();

  window.fetchUserResponses = async () => {
    const snapshot = await getDocs(collection(db, "nftclientResponses"));
    const userResponses = [];
    const seen = new Set();

    snapshot.forEach((doc) => {
      const data = doc.data();
      const key = [normalize(data["form_005_first-name"]), normalize(data["form_006_last-name"]), normalize(data["form_007_email"])].join("||");

      if (!seen.has(key)) {
        seen.add(key);
        userResponses.push({
          id: doc.id,
          firstName: data["form_005_first-name"] || "Unknown",
          lastName: data["form_006_last-name"] || "Unknown",
          email: data["form_007_email"] || "",
          country: data["form_003_evaluation_country"] || "Unknown",
          empstatus: data["form_015_employment"] || "Unspecified",
          institution: data["form_016_employer-name"] || "Unspecified",
          partAScore: Number(data["form_042_PartA_Score"]) || 0,
          partBScore: Number(data["form_044_PartB_Score"]) || 0,
        });
      }
    });

    loadUserResponsesIntoTable(userResponses);
    console.log("üß† Unique User Responses:", userResponses.length);
  };

  const getColorForScore = (score, part) => {
    const ranges = part === "A"
      ? [
          { range: [0, 57], color: "#FF0000" },
          { range: [57, 63], color: "#FF8C00" },
          { range: [63, 86], color: "#FFFC00" },
          { range: [86, 100.01], color: "#00FF00" },
        ]
      : [
          { range: [0, 29], color: "#FF0000" },
          { range: [29, 54], color: "#FF8C00" },
          { range: [54, 79], color: "#FFFC00" },
          { range: [79, 100.01], color: "#00FF00" },
        ];
    for (let r of ranges) {
      if (score >= r.range[0] && score < r.range[1]) return r.color;
    }
    return "#ccc";
  };

  const loadUserResponsesIntoTable = (userResponses) => {
    const tableBody = document.querySelector("#userTable tbody");
    if (!tableBody) return;
    tableBody.innerHTML = "";

    const grouped = {};
    userResponses.forEach((r) => {
      const inst = r.institution || "Unspecified";
      if (!grouped[inst]) grouped[inst] = [];
      grouped[inst].push(r);
    });

    let globalIndex = 0;

    Object.entries(grouped).forEach(([institution, users]) => {
      const groupRow = document.createElement("tr");
      groupRow.innerHTML = `<td colspan="7" style="background:#eef;font-weight:bold;">üè¢ Institution: ${institution} (${users.length})</td>`;
      tableBody.appendChild(groupRow);

      users.forEach((response) => {
        const partAPercent = Math.round((response.partAScore / 70) * 100);
        const partBPercent = Math.round((response.partBScore / 240) * 100);

        const partAColor = getColorForScore(partAPercent, "A");
        const partBColor = getColorForScore(partBPercent, "B");

        const row = document.createElement("tr");
        row.classList.add("main-row");
        row.setAttribute("data-index", globalIndex);

        row.innerHTML = `
          <td><strong>${response.firstName} ${response.lastName}</strong></td>
          <td>${response.country}</td>
          <td>${response.empstatus}</td>
          <td>${response.institution}</td>
          <td style="background:${partAColor};color:#000;font-weight:bold;text-align:center;">${partAPercent}%</td>
          <td style="background:${partBColor};color:#000;font-weight:bold;text-align:center;">${partBPercent}%</td>
          <td><button class="expand-btn" onclick="toggleDetails(${globalIndex}, '${normalize(response.firstName)}', '${normalize(response.lastName)}', '${normalize(response.email)}')">üîç</button></td>
        `;

        const detailRow = document.createElement("tr");
        detailRow.classList.add("detail-row");
        detailRow.style.display = "none";
        detailRow.innerHTML = `
          <td colspan="7">
            <div class="detail-panel fade-in">
              <p><strong>üìà Assessment Trend Over Time</strong> (percentages reflect emotional well-being changes):</p>
              <div style="height:300px;">
                <canvas id="trendChart-${globalIndex}" style="height:100%; width:100%; max-height:300px;"></canvas>
              </div>
              <label style="display:block; margin-top:1em;">
                <input type="checkbox" onchange="toggleRawScores(this, ${globalIndex}, '${normalize(response.firstName)}', '${normalize(response.lastName)}', '${normalize(response.email)}')"> Show raw scores
              </label>
              <p><strong>Full Name:</strong> ${response.firstName} ${response.lastName}</p>
              <button onclick="viewFullProfile('${response.id}')">üìÑ Full Profile</button>
            </div>
          </td>
        `;

        tableBody.appendChild(row);
        tableBody.appendChild(detailRow);
        globalIndex++;
      });
    });
  };

  window.toggleDetails = async (index, firstName, lastName, email) => {
    const detailRows = document.querySelectorAll(".detail-row");
    detailRows.forEach((row, i) => {
      row.style.display = i === index ? (row.style.display === "none" ? "table-row" : "none") : "none";
    });
    renderChart(index, firstName, lastName, email, false);
  };

  window.toggleRawScores = async (checkbox, index, firstName, lastName, email) => {
    renderChart(index, firstName, lastName, email, checkbox.checked);
  };

  async function renderChart(index, firstName, lastName, email, showRaw) {
    const canvas = document.getElementById(`trendChart-${index}`);
    if (!canvas) return;

    if (chartInstances[index]) {
      chartInstances[index].destroy();
      delete chartInstances[index];
    }

    const snapshot = await getDocs(collection(db, "nftclientResponses"));
    const trendData = [];

    snapshot.forEach((doc) => {
      const data = doc.data();
      if (
        normalize(data["form_005_first-name"]) === firstName &&
        normalize(data["form_006_last-name"]) === lastName &&
        normalize(data["form_007_email"]) === email
      ) {
        const date = data["form_000_evaluationDate"];
        const a = Number(data["form_042_PartA_Score"]);
        const b = Number(data["form_044_PartB_Score"]);
        const percA = (a / 70) * 100;
        const percB = (b / 240) * 100;

        if (!isNaN(a) && !isNaN(b) && date) {
          trendData.push({
            date,
            partA: showRaw ? a : percA,
            partB: showRaw ? b : percB,
          });
        }
      }
    });

    trendData.sort((a, b) => new Date(a.date) - new Date(b.date));

    const ctx = canvas.getContext("2d");
    chartInstances[index] = new Chart(ctx, {
      type: "line",
      data: {
        labels: trendData.map((d) => d.date),
        datasets: [
          {
            label: showRaw ? "Part A (raw)" : "Part A (%)",
            data: trendData.map((d) => d.partA),
            borderColor: "#16a085",
            backgroundColor: "rgba(22, 160, 133, 0.1)",
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: "#16a085",
          },
          {
            label: showRaw ? "Part B (raw)" : "Part B (%)",
            data: trendData.map((d) => d.partB),
            borderColor: "#8e44ad",
            backgroundColor: "rgba(142, 68, 173, 0.1)",
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: "#8e44ad",
          },
        ],
      },
      options: {
        animation: { duration: 1000, easing: "easeOutQuart" },
        plugins: {
          legend: {
            display: true,
            labels: { color: "#444", font: { size: 14, weight: "bold" } },
          },
          tooltip: { mode: "index", intersect: false },
        },
        scales: {
          y: {
            beginAtZero: true,
            max: showRaw ? undefined : 100,
            title: {
              display: true,
              text: showRaw ? "Raw Score" : "Score (%)",
            },
          },
          x: { title: { display: true, text: "Date" } },
        },
        responsive: true,
        maintainAspectRatio: false,
      },
    });
  }

  window.viewFullProfile = (userId) => {
    alert("Full profile viewer not implemented. User ID: " + userId);
  };

  document.addEventListener("DOMContentLoaded", () => {
    window.fetchUserResponses();
  });
</script>



    </body>
</html>
